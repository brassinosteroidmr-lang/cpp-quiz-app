<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPP Study - Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .chapter-dropdown { padding: 10px; margin: 10px 0; min-width: 300px; }
        .nav-btn { padding: 10px 20px; margin: 10px; cursor: pointer; }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #study-content { border: 1px solid #ccc; padding: 15px; margin: 10px 0; min-height: 200px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>CPP Study - 動作テスト</h1>
    
    <div class="test-section">
        <h2>データ読み込みテスト</h2>
        <div id="data-status" class="log">Loading...</div>
        <button onclick="checkData()">データ確認</button>
    </div>

    <div class="test-section">
        <h2>章選択テスト</h2>
        <select id="chapter-select" class="chapter-dropdown">
            <option value="">読み込み中...</option>
        </select>
        <button onclick="populateDropdown()">ドロップダウン更新</button>
    </div>

    <div class="test-section">
        <h2>コンテンツ表示テスト</h2>
        <div id="study-content">初期コンテンツ</div>
        <button onclick="testLoadChapter()">第1章読み込み</button>
    </div>

    <div class="test-section">
        <h2>ナビゲーションテスト</h2>
        <button class="nav-btn prev" onclick="testPrevPage()">前へ</button>
        <button class="nav-btn next" onclick="testNextPage()">次へ</button>
        <div id="page-info">ページ情報</div>
    </div>

    <div class="test-section">
        <h2>ログ</h2>
        <div id="log-area" class="log"></div>
        <button onclick="clearLog()">ログクリア</button>
    </div>

    <!-- JavaScript -->
    <script src="textbook-data.js"></script>
    <script src="quiz-data.js"></script>
    <script>
        let currentChapter = 'ch1';
        let currentPageIndex = 0;

        function log(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}<br>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = '';
        }

        function checkData() {
            const status = document.getElementById('data-status');
            if (typeof TEXTBOOK_DATA !== 'undefined') {
                status.innerHTML = `✅ TEXTBOOK_DATA 読み込み済み<br>章数: ${TEXTBOOK_DATA.chapters.length}`;
                log(`データ確認: ${TEXTBOOK_DATA.chapters.length}章が利用可能`);
            } else {
                status.innerHTML = '❌ TEXTBOOK_DATA が読み込まれていません';
                log('エラー: TEXTBOOK_DATA が利用できません');
            }
        }

        function populateDropdown() {
            const select = document.getElementById('chapter-select');
            log('ドロップダウン更新開始');
            
            if (typeof TEXTBOOK_DATA !== 'undefined') {
                select.innerHTML = '';
                TEXTBOOK_DATA.chapters.forEach((chapter, index) => {
                    const option = document.createElement('option');
                    option.value = chapter.id;
                    option.textContent = chapter.title;
                    select.appendChild(option);
                    log(`章追加: ${chapter.id} - ${chapter.title}`);
                });
                
                // イベントリスナー設定
                select.addEventListener('change', (e) => {
                    log(`章選択変更: ${e.target.value}`);
                    currentChapter = e.target.value;
                    currentPageIndex = 0;
                    testLoadChapter();
                });
                
                log('ドロップダウン更新完了');
            } else {
                log('エラー: データが利用できません');
            }
        }

        function getChapterData(chapterKey) {
            if (typeof TEXTBOOK_DATA !== 'undefined') {
                return TEXTBOOK_DATA.chapters.find(chapter => chapter.id === chapterKey);
            }
            return null;
        }

        function getPageData(chapterKey, pageIndex) {
            const chapter = getChapterData(chapterKey);
            if (chapter && chapter.pages && chapter.pages[pageIndex]) {
                return chapter.pages[pageIndex];
            }
            return null;
        }

        function getChapterPageCount(chapterKey) {
            const chapter = getChapterData(chapterKey);
            return chapter ? chapter.pages.length : 0;
        }

        function testLoadChapter() {
            log(`章読み込み: ${currentChapter}, ページ: ${currentPageIndex}`);
            
            const pageData = getPageData(currentChapter, currentPageIndex);
            const studyContent = document.getElementById('study-content');
            
            if (pageData) {
                studyContent.innerHTML = `
                    <h3>${pageData.title}</h3>
                    ${pageData.content}
                `;
                log(`ページ読み込み成功: ${pageData.title}`);
                updatePageInfo();
            } else {
                studyContent.innerHTML = '❌ ページデータが見つかりません';
                log(`エラー: ページデータなし (${currentChapter}, ${currentPageIndex})`);
            }
        }

        function updatePageInfo() {
            const totalPages = getChapterPageCount(currentChapter);
            const pageInfo = document.getElementById('page-info');
            pageInfo.innerHTML = `現在: ${currentChapter} - ${currentPageIndex + 1}/${totalPages}`;
        }

        function testNextPage() {
            const totalPages = getChapterPageCount(currentChapter);
            log(`次ページ要求: 現在 ${currentPageIndex}/${totalPages}`);
            
            if (currentPageIndex < totalPages - 1) {
                currentPageIndex++;
                log(`次ページへ: ${currentPageIndex}`);
                testLoadChapter();
            } else {
                log('最後のページです');
            }
        }

        function testPrevPage() {
            log(`前ページ要求: 現在 ${currentPageIndex}`);
            
            if (currentPageIndex > 0) {
                currentPageIndex--;
                log(`前ページへ: ${currentPageIndex}`);
                testLoadChapter();
            } else {
                log('最初のページです');
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM読み込み完了');
            setTimeout(() => {
                checkData();
                populateDropdown();
                testLoadChapter();
            }, 100);
        });
    </script>
</body>
</html>